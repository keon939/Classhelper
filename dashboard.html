
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Classroom Helper Dashboard</title>
  <style>
    body { font-family: Arial, padding: 20px; }
    .admin, .student, .moderator { display: none; }
    textarea, input { width: 100%; max-width: 400px; }
    .chat-box { border: 1px solid #ccc; padding: 10px; max-width: 400px; height: 200px; overflow-y: scroll; margin-bottom: 10px; }
    .msg { border-bottom: 1px solid #eee; padding: 5px 0; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      push,
      onChildAdded,
      update,
      child
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADgCrG3hspwEO45ARRkRdOh7j_vvOhouY",
      authDomain: "rufed-c71e5.firebaseapp.com",
      databaseURL: "https://rufed-c71e5-default-rtdb.firebaseio.com",
      projectId: "rufed-c71e5",
      storageBucket: "rufed-c71e5.appspot.com",
      messagingSenderId: "408519198212",
      appId: "1:408519198212:web:31e0e246307d8b24935751"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;

    const usernameDisplay = document.getElementById("usernameDisplay");
    const adminPanel = document.querySelector(".admin");
    const studentPanel = document.querySelector(".student");
    const moderatorPanel = document.querySelector(".moderator");
    const chatBox = document.getElementById("chatBox");

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const snap = await get(child(ref(db), "users/" + user.uid));
        if (snap.exists()) {
          const info = snap.val();
          usernameDisplay.textContent = "ğŸ‘‹ Welcome, " + info.username;
          if (info.role === "admin") adminPanel.style.display = "block";
          else if (info.role === "moderator") moderatorPanel.style.display = "block";
          else studentPanel.style.display = "block";
          loadChat();
        }
      } else {
        location.href = "index.html";
      }
    });

    document.getElementById("logout").onclick = () => signOut(auth).then(() => location.href = "index.html");

    document.getElementById("sendMsg").onclick = async () => {
      const msg = document.getElementById("message").value;
      if (msg && currentUser) {
        const snap = await get(ref(db, 'users/' + currentUser.uid));
        if (snap.exists()) {
          const username = snap.val().username;
          await push(ref(db, 'chat'), {
            sender: username,
            text: msg,
            time: Date.now()
          });
          document.getElementById("message").value = "";
        }
      }
    };

    function loadChat() {
      const chatRef = ref(db, "chat");
      onChildAdded(chatRef, (data) => {
        const msg = data.val();
        const div = document.createElement("div");
        div.className = "msg";
        div.textContent = msg.sender + ": " + msg.text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // Simulate usage tracking and balance calculation
    setInterval(async () => {
      if (currentUser) {
        const userRef = ref(db, "users/" + currentUser.uid);
        const snap = await get(userRef);
        if (snap.exists()) {
          let usage = snap.val().usage || 0;
          usage += Math.floor(Math.random() * 5);
          const balance = usage * 0.05;
          update(userRef, { usage, balance });
          document.getElementById("usage").textContent = "Data used: " + usage + " MB";
          document.getElementById("balance").textContent = "Estimated Value: $" + balance.toFixed(2);
        }
      }
    }, 5000);
  </script>
</head>
<body>
  <h2 id="usernameDisplay">Loading...</h2>
  <button id="logout">Logout</button>

  <div class="admin">
    <h3>ğŸ”§ Admin Panel</h3>
    <p>Manage users, suspend students, change passcodes</p>
  </div>

  <div class="moderator">
    <h3>ğŸ›¡ï¸ Moderator Panel</h3>
    <p>View passcodes, assist users, moderate chat</p>
  </div>

  <div class="student">
    <h3>ğŸ“š Student Dashboard</h3>
    <textarea placeholder="Post something..."></textarea><br /><br />
    <input type="text" placeholder="Referral code" /><br /><br />
    <button disabled>ğŸ¤ Send Voice Note (Coming soon)</button>
    <br /><br />
    <div id="usage">Data used: --</div>
    <div id="balance">Estimated Value: --</div>
    <br />
    <div class="chat-box" id="chatBox"></div>
    <input type="text" id="message" placeholder="Type a message" />
    <button id="sendMsg">Send</button>
  </div>
</body>
</html>
